<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Pressure Control</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh; /* Full viewport height as a reference */
            margin: 0;
            background-color: #f0f0f0;
            overflow-y: auto; /* Enable vertical scrolling */
        }
        .button-container {
            display: flex;
            flex-direction: row;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap; /* Allow wrapping if needed */
            justify-content: center;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        button.selected {
            background-color: #2196F3;
            font-weight: bold;
        }
        select {
            padding: 10px;
            font-size: 16px;
            margin: 10px 0;
            border-radius: 5px;
            width: 200px;
        }
        #status, #receivedValue {
            margin: 5px 0;
            font-size: 18px;
            color: #333;
        }
        canvas {
            max-width: 600px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ESP32 Pressure Control</h1>
    <div class="button-container">
        <button id="connectBtn">Connect to ESP32</button>
        <button id="eighteenSix" disabled>18/6</button>
        <button id="twentyOneSeven" disabled>21/7</button>
        <button id="twentyFourEight" disabled>24/8</button>
        <button id="twentySevenNine" disabled>27/9</button>
        <button id="thirtyTen" disabled>30/10</button>
    </div>
    <p>Send lists via BLE (e.g., "(x1);(y1);(x2);(y2)" with 10 points each)</p>
    <select id="swingSelect">
        <option value="">Select a swing to plot</option>
    </select>
    <canvas id="swingChart"></canvas>
    <p id="status">Disconnected</p>
    <p id="receivedValue">Received Value: None</p>

    <script>
        let device, characteristic;
        let selectedButton = null;
        let chartInstance = null;
        const swings = {}; // { "swing N": { x1: [], y1: [], x2: [], y2: [] } }
        let swingCount = 0;
        let pendingSwing = { x1: null, y1: null, x2: null, y2: null };

        const serviceUUID = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
        const charUUID = 'beb5483e-36e1-4688-b7f5-ea07361b26a8';
        const triggerValues = ['18/6', '21/7', '24/8', '27/9', '30/10'];

        const connectBtn = document.getElementById('connectBtn');
        const eighteenSix = document.getElementById('eighteenSix');
        const twentyOneSeven = document.getElementById('twentyOneSeven');
        const twentyFourEight = document.getElementById('twentyFourEight');
        const twentySevenNine = document.getElementById('twentySevenNine');
        const thirtyTen = document.getElementById('thirtyTen');
        const swingSelect = document.getElementById('swingSelect');
        const status = document.getElementById('status');
        const receivedValue = document.getElementById('receivedValue');

        const buttons = [eighteenSix, twentyOneSeven, twentyFourEight, twentySevenNine, thirtyTen];

        function setSelectedButton(button) {
            buttons.forEach(btn => {
                btn.classList.remove('selected');
                btn.disabled = false;
            });
            button.classList.add('selected');
            selectedButton = button;
        }

        function parseInput(inputStr) {
            inputStr = inputStr.trim();
            if (inputStr.includes(';')) {
                const lists = inputStr.split(';').map(s => s.trim());
                if (lists.length === 4) {
                    return lists.map(list => {
                        if (list.startsWith('(') && list.endsWith(')')) {
                            list = '[' + list.slice(1, -1) + ']';
                        } else if (list.startsWith('{') && list.endsWith('}')) {
                            list = '[' + list.slice(1, -1) + ']';
                        } else if (list.includes(',')) {
                            list = '[' + list + ']';
                        }
                        try {
                            return JSON.parse(list);
                        } catch {
                            return [];
                        }
                    });
                }
                return [];
            }
            if (inputStr.startsWith('(') && inputStr.endsWith(')')) {
                inputStr = '[' + inputStr.slice(1, -1) + ']';
            } else if (inputStr.startsWith('{') && inputStr.endsWith('}')) {
                inputStr = '[' + inputStr.slice(1, -1) + ']';
            } else if (inputStr.includes(',')) {
                inputStr = '[' + inputStr + ']';
            }
            try {
                return JSON.parse(inputStr);
            } catch {
                return [];
            }
        }

        function addSwing(x1, y1, x2, y2) {
            if (x1.length === y1.length && x2.length === y2.length && x1.length > 0 && x2.length > 0) {
                swingCount++;
                const swingKey = `swing ${swingCount}`;
                swings[swingKey] = { x1, y1, x2, y2 };
                const option = document.createElement('option');
                option.value = swingKey;
                option.textContent = swingKey;
                swingSelect.appendChild(option);
                swingSelect.value = swingKey; // Auto-select the new swing
                plotSwing(swingKey); // Auto-plot the new swing
                status.textContent = `Added and plotted ${swingKey}`;
                return true;
            }
            status.textContent = 'Invalid swing data: Lists must have equal lengths and be non-empty';
            return false;
        }

        function plotSwing(swingKey) {
            if (chartInstance) chartInstance.destroy();
            const data = swings[swingKey];
            if (!data) return;

            const ctx = document.getElementById('swingChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Line 1',
                            data: data.x1.map((x, i) => ({ x, y: data.y1[i] })),
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.2)',
                            fill: false,
                            tension: 0.1, // Smooth lines
                            pointRadius: 2 // Small points for visibility
                        },
                        {
                            label: 'Line 2',
                            data: data.x2.map((x, i) => ({ x, y: data.y2[i] })),
                            borderColor: '#FF9800',
                            backgroundColor: 'rgba(255, 152, 0, 0.2)',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: swingKey },
                        legend: { display: true },
                        tooltip: {
                            enabled: true,
                            mode: 'nearest',
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        label += `x: ${context.parsed.x}, y: ${context.parsed.y}`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'X Axis' },
                            type: 'linear',
                            position: 'bottom',
                            ticks: { stepSize: 1 }
                        },
                        y: {
                            title: { display: true, text: 'Y Axis' },
                            type: 'linear',
                            position: 'left',
                            ticks: { stepSize: 5 }
                        }
                    }
                }
            });
        }

        connectBtn.addEventListener('click', async () => {
            try {
                if (!navigator.bluetooth) {
                    throw new Error('Web Bluetooth API is not available. Try Chrome or Safari.');
                }
                status.textContent = 'Requesting Bluetooth device...';
                console.log('Requesting device with filter:', { name: 'ESP32_PRESSURE' });
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'ESP32_PRESSURE' }],
                    optionalServices: [serviceUUID]
                });
                status.textContent = 'Connecting to GATT server...';
                console.log('Device selected:', device.name);
                const server = await device.gatt.connect();
                status.textContent = 'Discovering service...';
                console.log('GATT server connected, getting service:', serviceUUID);
                const service = await server.getPrimaryService(serviceUUID);
                status.textContent = 'Discovering characteristic...';
                console.log('Service found, getting characteristic:', charUUID);
                characteristic = await service.getCharacteristic(charUUID);
                status.textContent = 'Subscribing to notifications...';
                console.log('Starting notifications...');
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', (event) => {
                    const value = new TextDecoder().decode(event.target.value);
                    receivedValue.textContent = `Received Value: ${value}`;
                    console.log('Received notification:', value);

                    const parsed = parseInput(value);
                    if (Array.isArray(parsed) && parsed.length === 4) {
                        const [x1, y1, x2, y2] = parsed;
                        addSwing(x1, y1, x2, y2);
                        pendingSwing = { x1: null, y1: null, x2: null, y2: null };
                    } else if (Array.isArray(parsed) && parsed.length > 0) {
                        if (!pendingSwing.x1) pendingSwing.x1 = parsed;
                        else if (!pendingSwing.y1) pendingSwing.y1 = parsed;
                        else if (!pendingSwing.x2) pendingSwing.x2 = parsed;
                        else if (!pendingSwing.y2) {
                            pendingSwing.y2 = parsed;
                            addSwing(pendingSwing.x1, pendingSwing.y1, pendingSwing.x2, pendingSwing.y2);
                            pendingSwing = { x1: null, y1: null, x2: null, y2: null };
                        }
                    }
                });
                status.textContent = 'Connected!';
                console.log('Characteristic found and notifications started:', charUUID);
                connectBtn.disabled = true;
                buttons.forEach(btn => btn.disabled = false);
            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                console.error('Connection error:', error);
            }
        });

        swingSelect.addEventListener('change', () => {
            const swingKey = swingSelect.value;
            if (swingKey && swings[swingKey]) {
                plotSwing(swingKey);
                status.textContent = `Plotted ${swingKey}`;
            } else {
                if (chartInstance) chartInstance.destroy();
                status.textContent = 'No swing selected';
            }
        });

        eighteenSix.addEventListener('click', async () => {
            try {
                console.log('Sending: 18/6');
                await characteristic.writeValue(new TextEncoder().encode('18/6'));
                status.textContent = '18/6 Command Sent';
                setSelectedButton(eighteenSix);
            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                console.error('18/6 error:', error);
            }
        });

        twentyOneSeven.addEventListener('click', async () => {
            try {
                console.log('Sending: 21/7');
                await characteristic.writeValue(new TextEncoder().encode('21/7'));
                status.textContent = '21/7 Command Sent';
                setSelectedButton(twentyOneSeven);
            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                console.error('21/7 error:', error);
            }
        });

        twentyFourEight.addEventListener('click', async () => {
            try {
                console.log('Sending: 24/8');
                await characteristic.writeValue(new TextEncoder().encode('24/8'));
                status.textContent = '24/8 Command Sent';
                setSelectedButton(twentyFourEight);
            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                console.error('24/8 error:', error);
            }
        });

        twentySevenNine.addEventListener('click', async () => {
            try {
                console.log('Sending: 27/9');
                await characteristic.writeValue(new TextEncoder().encode('27/9'));
                status.textContent = '27/9 Command Sent';
                setSelectedButton(twentySevenNine);
            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                console.error('27/9 error:', error);
            }
        });

        thirtyTen.addEventListener('click', async () => {
            try {
                console.log('Sending: 30/10');
                await characteristic.writeValue(new TextEncoder().encode('30/10'));
                status.textContent = '30/10 Command Sent';
                setSelectedButton(thirtyTen);
            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                console.error('30/10 error:', error);
            }
        });

        device?.addEventListener('gattserverdisconnected', () => {
            status.textContent = 'Disconnected';
            console.log('Device disconnected');
            connectBtn.disabled = false;
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.classList.remove('selected');
            });
            swingSelect.innerHTML = '<option value="">Select a swing to plot</option>';
            if (chartInstance) chartInstance.destroy();
            selectedButton = null;
            device = null;
            characteristic = null;
        });
    </script>
</body>
</html>